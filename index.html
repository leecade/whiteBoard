<!DOCTYPE html>

<head>
    <meta content="width=device-width,maximum-scale=1.0,initial-scale=1.0,minimum-scale=1.0,user-scalable=yes,shrink-to-fit=no" name="viewport">
    <style>
        * {margin: 0; padding: 0;}
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #canvas {
            width: 800px;
            height: 600px;
            background: #f0f;
        }
        #canvasScrollbar {
            width: 800px;
            height: 100px;
            background: #00f;
        }
        .wrapper {
    position: relative;
    width: 400px;
    height: 300px;
}

.wrapper canvas {
    position: absolute;
    top: 0;
    left: 0;
}

.rangeBar{
    width: 800px;
}

.rangeBar input{
    width: calc(100% - 60px);
    vertical-align: middle;
}

.controlButton{
    width: 35px;
    height: 35px;
    background: url(img/play_black.png);
    display: inline-block;
    background-size: cover;
    vertical-align: middle;
    cursor: pointer;
}

.controlButton.pause {
    background-image: url(img/pause_black.png);
}
    </style>
    
</head>
<body>
    
    <div>
        <canvas id="canvas" width="800" height="600">
    </canvas>
    </div>
    <div id="rangeBar" class="rangeBar">
        <span class="controlButton"></span>
        <input id="rangeBarInput" type="range" min="0" max ="100" value="0">
    </div>
    
     <!--<canvas id="canvasScrollbar" width="800" height="100">
    </canvas>-->
 
</body>
<script>
var canvas = document.getElementById('canvas')
var ctx = canvas.getContext('2d')
var isMousedownFlag = false
var isFirstProgressBarFlag = true
var numberOfResult=0
var timerRecord = null
var globalEvent = null
var maxVal = 0
var startTime = null
var result = []


canvas.onmousedown = canvas.ontouchstart = function(e) {
    e.preventDefault()
    isMousedownFlag = true
    
    startTime = startTime || +new Date
    
    ctx.moveTo(e.touches ? e.touches[0].pageX : e.pageX, e.touches ? e.touches[0].pageY : e.pageY)
    
    //startTime = +new Date
    
    result.push({
        type: e.type,
        t: +new Date - startTime
    })
    // timerRecord = setInterval(function() {
    //     if (globalEvent) {
    //         result.push({
    //             x: globalEvent.pageX,
    //             y: globalEvent.pageY,
    //             t: +new Date - startTime
    //         })    
    //     }
    // }, 100)
}


canvas.onmousemove = canvas.ontouchmove = function(e) {
    e.preventDefault()
    if (isMousedownFlag) {
        var x = e.touches ? e.touches[0].pageX : e.pageX
        var y = e.touches ? e.touches[0].pageY : e.pageY
        ctx.lineTo(x, y)
        ctx.stroke()
        result.push({
            type: e.type,
            x: x,
            y: y,
            t: +new Date - startTime
        })
        globalEvent = e
    }
}


canvas.onmouseup = canvas.ontouchend = function(e) {
    e.preventDefault()
    globalEvent = null
    isMousedownFlag = false
    
    // numberOfResult = result.length
    // if (numberOfResult>0){
    // maxVal=result[numberOfResult-1].t
}
    // if (timerRecord) clearInterval(timerRecord)
  //  drawScrollbar ()
// }

/*
//progress Bar
var progressBarEvent = null
var progressBarResult = []
var progressBarMax = 800;
var progressBarVal = 0;
var fillVal=0;
var dragging = false
var lastX = 0
var translated = 0;

var canvasScrollbar = document.getElementById('canvasScrollbar')
var ctxScrollbar = canvasScrollbar.getContext('2d')

//canvasScrollbar.setUseObjectMouseEvents(true);
canvasScrollbar.onmousedown = function(e){
  var evt = e || event;
  dragging = true;
  lastX = evt.offsetX;
}

//Draw the graphy according to the position of scrollbar
canvasScrollbar.onmousemove = function(e){
  var evt = e || event;
  if (dragging){
      var delta = evt.offsetX - lastX;
      translated += delta; //?
      ctxScrollbar.translate(delta, 0); //?
      lastX = evt.offsetX;
      fillVal = e.touches ? e.touches[0] : lastX
      progressBarEvent = e
  }
  
  drawBack(fillVal);
}

canvasScrollbar.onmouseup = function(e){
    var evt = e || event;
    if (dragging){
     //   var delta = evt.offsetX - lastX;
       // lastX = evt.offsetX;
       // var x = e.touches ? e.touches[0] : lastX
        progressBarResult.push({
            x: fillVal
        })
        progressBarEvent = e
    }
    //ToDo: get ready for camera and video recording
    dragging = false;
    e.preventDefault()
    progressBarEvent = null
    isMousedownFlag = false
    drawScrollbar ();
}

//dRAW Scollbar, so people know where the bar is dragged to 
function drawScrollbar () {
    direction = "horizontal";
    if (isFirstProgressBarFlag){
        ctxScrollbar.fillStyle = '#000';
        ctxScrollbar.fillRect(0, 460, 800, 20);  
        isFirstProgressBarFlag=false
    }else{
        if(result.length >0){
          // Draw the fill
            progressBarVal=result[numberOfResult-1].t
            ctxScrollbar.fillStyle = '#98000';
            fillVal = progressBarMax/maxVal*progressBarResult[progressBarResult.length-1].x;
            ctxScrollbar.fillRect(0, 460, fillVal, 20);
        }
    }
}


function drawBack(position){
    //find the index according to the time value of the object
    var location = findIndexWithTime(result,t, position)
    // go through a loop to draw the image
    var node = null
    while (node = result[location]) {
        ctx.lineTo(node.x, node.y)
        ctx.stroke()
    }
}

//find the index of the object according to the time value
function findIndexWithTime(array, attr, value) {
    for(var i = 0; i < array.length; i += 1) {
        if(array[i][attr] === value) {
            return i;
        }
    }
}
*/

// var preData = [{"type":"mousemove","x":218,"y":70},{"type":"mousemove","x":218,"y":72},{"type":"mousemove","x":217,"y":75},{"type":"mousemove","x":215,"y":79},{"type":"mousemove","x":214,"y":85},{"type":"mousemove","x":211,"y":92},{"type":"mousemove","x":208,"y":99},{"type":"mousemove","x":205,"y":107},{"type":"mousemove","x":202,"y":116},{"type":"mousemove","x":199,"y":122}]

// ctx.moveTo(preData[0].x, preData[0].y)

// var len = preData.length - 1
// var node = null
// while (node = preData[len--]) {
//     ctx.lineTo(node.x, node.y)
//     ctx.stroke()
// }

// [{
//     x:0,
//     y:1,
//     t:1
// }, {
//     x:100,
//     y:100,
//     t:112
// }, {
//     x:100,
//     y:100,
//     t:132
// }]

// // 100ms

// [100, 100, 100]

// [[{
//     x:0,
//     y:1,
//     t:1
// }, {
//     x:0,
//     y:1,
//     t:99
// }], [
//     {
//         x:0,
//         y:1,
//         t:100
//     }, {
//         x:0,
//         y:1,
//         t:101
//     }
// ], []]



var rangeBarInput = document.getElementById('rangeBarInput')
rangeBarInput.addEventListener('change', function(e) {
  //  console.log(e.target.value)
  var curData = getArrayByPos(e.target.value)
  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.beginPath()
  ctx.moveTo(curData[0].x, curData[0].y)
  curData.map(function(item) {
        if (item.type === 'mousedown') {
            ctx.beginPath()         
        }
        curData.shift()
        ctx.lineTo(item.x, item.y)
        ctx.stroke()      
  })
})

var controlButton = document.querySelector('#rangeBar .controlButton')
var curPos = 0
var playTimer


function getArrayByPos(pos) {
    var data = result.slice(0)
    var t = data[data.length - 1].t - data[0].t
    var xx = []
     data.some(function(item) {
        if (item.t < t * pos / 100) {
            xx.push(item)
        } 
     })
     return xx
} 

function handleButon(e) {
    var speed =  Math.min(result.length/10, 100)
   // var speed =  result.length/100
    var data = result.slice(0)
    var isPlaying = controlButton.className === 'controlButton'
    if (isPlaying) {
        controlButton.className = 'controlButton pause'
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        var beginIndex = 0;
        var t = data[data.length - 1].t - data[0].t
        ctx.beginPath()
        playTimer = setInterval(function() {
            if (curPos === 100) {
                rangeBarInput.value = curPos = 0
                controlButton.className = 'controlButton'
                return clearInterval(playTimer)
            }
            rangeBarInput.value = curPos++
            data.some(function(item) {
                if (item.t < t * curPos / 100) {
                     console.log(item.type)
                    if (item.type === 'mousedown') {
                        console.log(11)
                        ctx.beginPath()
                    }
                    data.shift()
                    ctx.lineTo(item.x, item.y)
                    ctx.stroke()
                } else return true
            })
        }, speed)
    }
    
  //  1000 - 30000 /  result.length
    else {
        controlButton.className = 'controlButton'
        clearInterval(playTimer)
    }
}
controlButton.addEventListener('click', handleButon)
controlButton.addEventListener('touchend', handleButon)




</script>
    
    
</html>