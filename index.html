<!DOCTYPE html>

<head>
    <meta content="width=device-width,maximum-scale=1.0,initial-scale=1.0,minimum-scale=1.0,user-scalable=yes,shrink-to-fit=no" name="viewport">
    <style>
        * {margin: 0; padding: 0;}
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #canvas {
            width: 800px;
            height: 450px;
            background: #f0f;
        }
        #canvasScrollbar {
            width: 800px;
            height: 100px;
            background: #00f;
        }
        .wrapper {
    position: relative;
    width: 400px;
    height: 300px;
}

.wrapper canvas {
    position: absolute;
    top: 0;
    left: 0;
}

    </style>
    
</head>
<body> 
        
    <canvas id="canvas" width="800" height="600">
    </canvas>
    
     <canvas id="canvasScrollbar" width="800" height="100">
    </canvas>
 
</body>
<script>
var canvas = document.getElementById('canvas')
var ctx = canvas.getContext('2d')
var isMousedownFlag = false
var isFirstProgressBarFlag = true
var numberOfResult=0
var timerRecord = null
var globalEvent = null
var maxVal = 0
var startTime = null
var result = []


canvas.onmousedown = canvas.ontouchstart = function(e) {
    e.preventDefault()
    isMousedownFlag = true
    ctx.moveTo(e.touches ? e.touches[0].pageX : e.pageX, e.touches ? e.touches[0].pageY : e.pageY)
    
    startTime = +new Date
    // timerRecord = setInterval(function() {
    //     if (globalEvent) {
    //         result.push({
    //             x: globalEvent.pageX,
    //             y: globalEvent.pageY,
    //             t: +new Date - startTime
    //         })    
    //     }
    // }, 100)
}


canvas.onmousemove = canvas.ontouchmove = function(e) {
    e.preventDefault()
    if (isMousedownFlag) {
        var x = e.touches ? e.touches[0].pageX : e.pageX
        var y = e.touches ? e.touches[0].pageY : e.pageY
        ctx.lineTo(x, y)
        ctx.stroke()
        result.push({
            type: e.type,
            x: x,
            y: y,
            t: +new Date - startTime
        })
        globalEvent = e
    }
}


canvas.onmouseup = canvas.ontouchend = function(e) {
    e.preventDefault()
    globalEvent = null
    isMousedownFlag = false
    
    numberOfResult = result.length
    if (numberOfResult>0){
    maxVal=result[numberOfResult-1].t
}
    if (timerRecord) clearInterval(timerRecord)
  //  drawScrollbar ()
}


//progress Bar
var progressBarEvent = null
var progressBarResult = []
var progressBarMax = 800;
var progressBarVal = 0;
var fillVal=0;
var dragging = false
var lastX = 0
var translated = 0;

var canvasScrollbar = document.getElementById('canvasScrollbar')
var ctxScrollbar = canvasScrollbar.getContext('2d')

//canvasScrollbar.setUseObjectMouseEvents(true);
canvasScrollbar.onmousedown = function(e){
  var evt = e || event;
  dragging = true;
  lastX = evt.offsetX;
}

//Draw the graphy according to the position of scrollbar
canvasScrollbar.onmousemove = function(e){
  var evt = e || event;
  if (dragging){
      var delta = evt.offsetX - lastX;
      translated += delta; //?
      ctxScrollbar.translate(delta, 0); //?
      lastX = evt.offsetX;
      fillVal = e.touches ? e.touches[0] : lastX
      progressBarEvent = e
  }
  drawBack(fillVal);
}

canvasScrollbar.onmouseup = function(e){
    var evt = e || event;
    if (dragging){
     //   var delta = evt.offsetX - lastX;
       // lastX = evt.offsetX;
       // var x = e.touches ? e.touches[0] : lastX
        progressBarResult.push({
            x: fillVal
        })
        progressBarEvent = e
    }
    //ToDo: get ready for camera and video recording
    dragging = false;
    e.preventDefault()
    progressBarEvent = null
    isMousedownFlag = false
    drawScrollbar ();
}

//dRAW Scollbar, so people know where the bar is dragged to 
function drawScrollbar () {
    direction = "horizontal";
    if (isFirstProgressBarFlag){
        ctxScrollbar.fillStyle = '#000';
        ctxScrollbar.fillRect(0, 460, 800, 20);  
        isFirstProgressBarFlag=false
    }else{
        if(result.length >0){
          // Draw the fill
            progressBarVal=result[numberOfResult-1].t
            ctxScrollbar.fillStyle = '#98000';
            fillVal = progressBarMax/maxVal*progressBarResult[progressBarResult.length-1].x;
            ctxScrollbar.fillRect(0, 460, fillVal, 20);
        }
    }
}


function drawBack(position){
    //find the index according to the time value of the object
    var location = findIndexWithTime(result,t, position)
    // go through a loop to draw the image
    var node = null
    while (node = result[location]) {
        ctx.lineTo(node.x, node.y)
        ctx.stroke()
    }
}

//find the index of the object according to the time value
function findIndexWithTime(array, attr, value) {
    for(var i = 0; i < array.length; i += 1) {
        if(array[i][attr] === value) {
            return i;
        }
    }
}

// var preData = [{"type":"mousemove","x":218,"y":70},{"type":"mousemove","x":218,"y":72},{"type":"mousemove","x":217,"y":75},{"type":"mousemove","x":215,"y":79},{"type":"mousemove","x":214,"y":85},{"type":"mousemove","x":211,"y":92},{"type":"mousemove","x":208,"y":99},{"type":"mousemove","x":205,"y":107},{"type":"mousemove","x":202,"y":116},{"type":"mousemove","x":199,"y":122}]

// ctx.moveTo(preData[0].x, preData[0].y)

// var len = preData.length - 1
// var node = null
// while (node = preData[len--]) {
//     ctx.lineTo(node.x, node.y)
//     ctx.stroke()
// }

</script>
    
    
</html>